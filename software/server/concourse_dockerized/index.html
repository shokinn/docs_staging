



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Everything which I have to write down to remember it">
      
      
      
        <meta name="author" content="Philip Henning">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Concourse Dockerized - Philip's docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../../#concourse-dockerized" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Philip's docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Philip's docs
              </span>
              <span class="md-header-nav__topic">
                Concourse Dockerized
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/shokinn/docs/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      shokinn/docs
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Philip's docs" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    Philip's docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/shokinn/docs/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      shokinn/docs
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Hardware
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Hardware
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Dell XPS 15 9560
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Dell XPS 15 9560
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../hardware/dell_xps_15_9560/dell_xps_15_9560_arch_linux/" title="Arch Linux" class="md-nav__link">
      Arch Linux
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Desktop
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        Desktop
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../desktop/playonlinux/" title="PlayOnLinux" class="md-nav__link">
      PlayOnLinux
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" checked>
    
    <label class="md-nav__link" for="nav-3-2">
      Server
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Server
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Concourse Dockerized
      </label>
    
    <a href="./" title="Concourse Dockerized" class="md-nav__link md-nav__link--active">
      Concourse Dockerized
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initial-server-setup" title="Initial Server setup" class="md-nav__link">
    Initial Server setup
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-system" title="Update System" class="md-nav__link">
    Update System
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-vim-colored-with-dark-background-settings" title="Make vim colored with dark background settings" class="md-nav__link">
    Make vim colored with dark background settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fix-locale" title="Fix locale" class="md-nav__link">
    Fix locale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-bashrc" title="Edit .bashrc" class="md-nav__link">
    Edit .bashrc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-user-user" title="Create a new user user" class="md-nav__link">
    Create a new user user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-the-ssh-deamon-to-allow-only-ssh-keys" title="Change the SSH deamon to allow only SSH-keys" class="md-nav__link">
    Change the SSH deamon to allow only SSH-keys
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delete-roots-authorized_keys-file" title="Delete root's authorized_keys file" class="md-nav__link">
    Delete root's authorized_keys file
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-base-packages" title="Install base packages" class="md-nav__link">
    Install base packages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker" title="Docker" class="md-nav__link">
    Docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pre-requirements" title="Pre-requirements" class="md-nav__link">
    Pre-requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-docker" title="Install Docker" class="md-nav__link">
    Install Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-docker-network-for-concourse" title="Create a new docker network for concourse" class="md-nav__link">
    Create a new docker network for concourse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-portainer" title="Install Portainer" class="md-nav__link">
    Install Portainer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgresql" title="PostgreSQL" class="md-nav__link">
    PostgreSQL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" title="Install" class="md-nav__link">
    Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup" title="Backup" class="md-nav__link">
    Backup
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../quassel/" title="Quassel" class="md-nav__link">
      Quassel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Knowledge base
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Knowledge base
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../kb/change_tty/" title="How to change to TTYn" class="md-nav__link">
      How to change to TTYn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../kb/mkdocs/" title="MkDocs testing environment" class="md-nav__link">
      MkDocs testing environment
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../imprint/" title="Impressum" class="md-nav__link">
      Impressum
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../datenschutzerklaerung/" title="Datenschutzerklärung" class="md-nav__link">
      Datenschutzerklärung
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initial-server-setup" title="Initial Server setup" class="md-nav__link">
    Initial Server setup
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-system" title="Update System" class="md-nav__link">
    Update System
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-vim-colored-with-dark-background-settings" title="Make vim colored with dark background settings" class="md-nav__link">
    Make vim colored with dark background settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fix-locale" title="Fix locale" class="md-nav__link">
    Fix locale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-bashrc" title="Edit .bashrc" class="md-nav__link">
    Edit .bashrc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-user-user" title="Create a new user user" class="md-nav__link">
    Create a new user user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-the-ssh-deamon-to-allow-only-ssh-keys" title="Change the SSH deamon to allow only SSH-keys" class="md-nav__link">
    Change the SSH deamon to allow only SSH-keys
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delete-roots-authorized_keys-file" title="Delete root's authorized_keys file" class="md-nav__link">
    Delete root's authorized_keys file
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-base-packages" title="Install base packages" class="md-nav__link">
    Install base packages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker" title="Docker" class="md-nav__link">
    Docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pre-requirements" title="Pre-requirements" class="md-nav__link">
    Pre-requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-docker" title="Install Docker" class="md-nav__link">
    Install Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-docker-network-for-concourse" title="Create a new docker network for concourse" class="md-nav__link">
    Create a new docker network for concourse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-portainer" title="Install Portainer" class="md-nav__link">
    Install Portainer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgresql" title="PostgreSQL" class="md-nav__link">
    PostgreSQL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install" title="Install" class="md-nav__link">
    Install
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup" title="Backup" class="md-nav__link">
    Backup
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/shokinn/docs/edit/master/docs/software/server/concourse_dockerized.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="concourse-dockerized">Concourse dockerized<a class="headerlink" href="#concourse-dockerized" title="Permanent link">&para;</a></h1>
<p>OS: Ubuntu 18.04 LTS (Bionic Beaver)</p>
<h2 id="initial-server-setup">Initial Server setup<a class="headerlink" href="#initial-server-setup" title="Permanent link">&para;</a></h2>
<h3 id="update-system">Update System<a class="headerlink" href="#update-system" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>apt update <span class="o">&amp;&amp;</span> apt full-upgrade -y
</pre></div>
</td></tr></table>

<h3 id="make-vim-colored-with-dark-background-settings">Make vim colored with dark background settings<a class="headerlink" href="#make-vim-colored-with-dark-background-settings" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF &gt;&gt; /etc/vim/vimrc</span>

<span class="s">&quot; Set background to dark for better readability in SSH connections</span>
<span class="s">set background=dark</span>
<span class="s">EOF</span>
</pre></div>
</td></tr></table>

<h3 id="fix-locale">Fix locale<a class="headerlink" href="#fix-locale" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF | sudo tee -a /etc/environment</span>

<span class="s"># Fix locale</span>
<span class="s">LC_ALL=en_US.UTF-8</span>
<span class="s">LANGUAGE=en_US:en</span>
<span class="s">EOF</span>
</pre></div>
</td></tr></table>

<h3 id="edit-bashrc">Edit .bashrc<a class="headerlink" href="#edit-bashrc" title="Permanent link">&para;</a></h3>
<p><code>/root/.bashrc</code> / <code>/etc/skel/.bashrc</code>:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># ~/.bashrc: executed by bash(1) for non-login shells.</span>
<span class="c1"># see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)</span>
<span class="c1"># for examples</span>

<span class="c1"># If not running interactively, don&#39;t do anything</span>
<span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$PS1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>

<span class="c1"># don&#39;t put duplicate lines in the history. See bash(1) for more options</span>
<span class="c1"># ... or force ignoredups and ignorespace</span>
<span class="nv">HISTCONTROL</span><span class="o">=</span>ignoredups:ignorespace

<span class="c1"># append to the history file, don&#39;t overwrite it</span>
<span class="nb">shopt</span> -s histappend

<span class="c1"># for setting history length see HISTSIZE and HISTFILESIZE in bash(1)</span>
<span class="nv">HISTSIZE</span><span class="o">=</span><span class="m">999999</span>
<span class="nv">HISTFILESIZE</span><span class="o">=</span><span class="m">999999</span>

<span class="c1"># check the window size after each command and, if necessary,</span>
<span class="c1"># update the values of LINES and COLUMNS.</span>
<span class="nb">shopt</span> -s checkwinsize

<span class="c1"># make less more friendly for non-text input files, see lesspipe(1)</span>
<span class="o">[</span> -x /usr/bin/lesspipe <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span><span class="nv">SHELL</span><span class="o">=</span>/bin/sh lesspipe<span class="k">)</span><span class="s2">&quot;</span>

<span class="c1"># set variable identifying the chroot you work in (used in the prompt below)</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$debian_chroot</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -r /etc/debian_chroot <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">debian_chroot</span><span class="o">=</span><span class="k">$(</span>cat /etc/debian_chroot<span class="k">)</span>
<span class="k">fi</span>

<span class="c1"># set a fancy prompt (non-color, unless we know we &quot;want&quot; color)</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$TERM</span><span class="s2">&quot;</span> in
    xterm-color<span class="o">)</span> <span class="nv">color_prompt</span><span class="o">=</span>yes<span class="p">;;</span>
<span class="k">esac</span>

<span class="c1"># uncomment for a colored prompt, if the terminal has the capability; turned</span>
<span class="c1"># off by default to not distract the user: the focus in a terminal window</span>
<span class="c1"># should be on the output of commands, not on the prompt</span>
<span class="nv">force_color_prompt</span><span class="o">=</span>yes

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$force_color_prompt</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> -x /usr/bin/tput <span class="o">]</span> <span class="o">&amp;&amp;</span> tput setaf <span class="m">1</span> &gt;<span class="p">&amp;</span>/dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="c1"># We have color support; assume it&#39;s compliant with Ecma-48</span>
    <span class="c1"># (ISO/IEC-6429). (Lack of such support is extremely rare, and such</span>
    <span class="c1"># a case would tend to support setf rather than setaf.)</span>
    <span class="nv">color_prompt</span><span class="o">=</span>yes
    <span class="k">else</span>
    <span class="nv">color_prompt</span><span class="o">=</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$color_prompt</span><span class="s2">&quot;</span> <span class="o">=</span> yes <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># PS1=&#39;${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#39;</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$UID</span> <span class="o">==</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">PS1</span><span class="o">=</span><span class="s1">&#39;${debian_chroot:+($debian_chroot)}\[\033[01;31m\]\u\[\033[01;33m\]@\[\033[01;36m\]\h \[\033[01;33m\]\w \[\033[01;35m\]\$ \[\033[00m\]&#39;</span>
    <span class="k">else</span>
        <span class="nv">PS1</span><span class="o">=</span><span class="s1">&#39;${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u\[\033[01;33m\]@\[\033[01;36m\]\h \[\033[01;33m\]\w \[\033[01;35m\]\$ \[\033[00m\]&#39;</span>
    <span class="k">fi</span>
<span class="k">else</span>
    <span class="nv">PS1</span><span class="o">=</span><span class="s1">&#39;${debian_chroot:+($debian_chroot)}\u@\h:\w\$ &#39;</span>
<span class="k">fi</span>
<span class="nb">unset</span> color_prompt force_color_prompt

<span class="c1"># If this is an xterm set the title to user@host:dir</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$TERM</span><span class="s2">&quot;</span> in
xterm*<span class="p">|</span>rxvt*<span class="o">)</span>
    <span class="nv">PS1</span><span class="o">=</span><span class="s2">&quot;\[\e]0;</span><span class="si">${</span><span class="nv">debian_chroot</span><span class="p">:+(</span><span class="nv">$debian_chroot</span><span class="p">)</span><span class="si">}</span><span class="s2">\u@\h: \w\a\]</span><span class="nv">$PS1</span><span class="s2">&quot;</span>
    <span class="p">;;</span>
*<span class="o">)</span>
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="c1"># enable color support of ls and also add handy aliases</span>
<span class="k">if</span> <span class="o">[</span> -x /usr/bin/dircolors <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">test</span> -r ~/.dircolors <span class="o">&amp;&amp;</span> <span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>dircolors -b ~/.dircolors<span class="k">)</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>dircolors -b<span class="k">)</span><span class="s2">&quot;</span>
    <span class="nb">alias</span> <span class="nv">ls</span><span class="o">=</span><span class="s1">&#39;ls --color=auto&#39;</span>
    <span class="c1">#alias dir=&#39;dir --color=auto&#39;</span>
    <span class="c1">#alias vdir=&#39;vdir --color=auto&#39;</span>

    <span class="nb">alias</span> <span class="nv">grep</span><span class="o">=</span><span class="s1">&#39;grep --color=auto&#39;</span>
    <span class="nb">alias</span> <span class="nv">fgrep</span><span class="o">=</span><span class="s1">&#39;fgrep --color=auto&#39;</span>
    <span class="nb">alias</span> <span class="nv">egrep</span><span class="o">=</span><span class="s1">&#39;egrep --color=auto&#39;</span>
<span class="k">fi</span>

<span class="c1"># some more ls aliases</span>
<span class="nb">alias</span> <span class="nv">ll</span><span class="o">=</span><span class="s1">&#39;ls -alF&#39;</span>
<span class="nb">alias</span> <span class="nv">la</span><span class="o">=</span><span class="s1">&#39;ls -A&#39;</span>
<span class="nb">alias</span> <span class="nv">l</span><span class="o">=</span><span class="s1">&#39;ls -CF&#39;</span>

<span class="c1"># Alias definitions.</span>
<span class="c1"># You may want to put all your additions into a separate file like</span>
<span class="c1"># ~/.bash_aliases, instead of adding them here directly.</span>
<span class="c1"># See /usr/share/doc/bash-doc/examples in the bash-doc package.</span>

<span class="k">if</span> <span class="o">[</span> -f ~/.bash_aliases <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    . ~/.bash_aliases
<span class="k">fi</span>

<span class="c1"># enable programmable completion features (you don&#39;t need to enable</span>
<span class="c1"># this, if it&#39;s already enabled in /etc/bash.bashrc and /etc/profile</span>
<span class="c1"># sources /etc/bash.bashrc).</span>
<span class="c1">#if [ -f /etc/bash_completion ] &amp;&amp; ! shopt -oq posix; then</span>
<span class="c1">#    . /etc/bash_completion</span>
<span class="c1">#fi</span>
</pre></div>
</td></tr></table></p>
<h3 id="create-a-new-user-user">Create a new user <code>user</code><a class="headerlink" href="#create-a-new-user-user" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>adduser user <span class="o">&amp;&amp;</span> <span class="se">\</span>
usermod -aG sudo user <span class="o">&amp;&amp;</span> <span class="se">\</span>
mkdir /home/user/.ssh <span class="o">&amp;&amp;</span> <span class="se">\</span>
chmod <span class="m">700</span> /home/user/.ssh <span class="o">&amp;&amp;</span> <span class="se">\</span>
cp /root/.ssh/authorized_keys /home/user/.ssh/ <span class="o">&amp;&amp;</span> <span class="se">\</span>
chmod <span class="m">400</span> /home/user/.ssh/authorized_keys <span class="o">&amp;&amp;</span> <span class="se">\</span>
chown -R user:user /home/user/.ssh/
</pre></div>
</td></tr></table>

<h3 id="change-the-ssh-deamon-to-allow-only-ssh-keys">Change the SSH deamon to allow only SSH-keys<a class="headerlink" href="#change-the-ssh-deamon-to-allow-only-ssh-keys" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF &gt; /etc/ssh/sshd_config &amp;&amp; systemctl restart sshd.service</span>
<span class="s">#   $OpenBSD: sshd_config,v 1.101 2017/03/14 07:19:07 djm Exp $</span>

<span class="s"># This is the sshd server system-wide configuration file.  See</span>
<span class="s"># sshd_config(5) for more information.</span>

<span class="s"># This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin</span>

<span class="s"># The strategy used for options in the default sshd_config shipped with</span>
<span class="s"># OpenSSH is to specify options with their default value where</span>
<span class="s"># possible, but leave them commented.  Uncommented options override the</span>
<span class="s"># default value.</span>

<span class="s">Port 22</span>
<span class="s">AddressFamily any</span>
<span class="s">ListenAddress 0.0.0.0</span>
<span class="s">ListenAddress ::</span>

<span class="s">HostKey /etc/ssh/ssh_host_rsa_key</span>
<span class="s">HostKey /etc/ssh/ssh_host_ecdsa_key</span>
<span class="s">HostKey /etc/ssh/ssh_host_ed25519_key</span>

<span class="s"># Ciphers and keying</span>
<span class="s">#RekeyLimit default none</span>

<span class="s"># Logging</span>
<span class="s">#SyslogFacility AUTH</span>
<span class="s">#LogLevel INFO</span>

<span class="s"># Authentication:</span>

<span class="s">#LoginGraceTime 2m</span>
<span class="s">PermitRootLogin without-password</span>
<span class="s">#StrictModes yes</span>
<span class="s">#MaxAuthTries 6</span>
<span class="s">#MaxSessions 10</span>

<span class="s">PubkeyAuthentication yes</span>

<span class="s"># Expect .ssh/authorized_keys2 to be disregarded by default in future.</span>
<span class="s">AuthorizedKeysFile  .ssh/authorized_keys .ssh/authorized_keys2</span>

<span class="s">#AuthorizedPrincipalsFile none</span>

<span class="s">#AuthorizedKeysCommand none</span>
<span class="s">#AuthorizedKeysCommandUser nobody</span>

<span class="s"># For this to work you will also need host keys in /etc/ssh/ssh_known_hosts</span>
<span class="s">#HostbasedAuthentication no</span>
<span class="s"># Change to yes if you don&#39;t trust ~/.ssh/known_hosts for</span>
<span class="s"># HostbasedAuthentication</span>
<span class="s">#IgnoreUserKnownHosts no</span>
<span class="s"># Don&#39;t read the user&#39;s ~/.rhosts and ~/.shosts files</span>
<span class="s">#IgnoreRhosts yes</span>

<span class="s"># To disable tunneled clear text passwords, change to no here!</span>
<span class="s">PasswordAuthentication no</span>
<span class="s">PermitEmptyPasswords no</span>

<span class="s"># Change to yes to enable challenge-response passwords (beware issues with</span>
<span class="s"># some PAM modules and threads)</span>
<span class="s">ChallengeResponseAuthentication no</span>

<span class="s"># Kerberos options</span>
<span class="s">#KerberosAuthentication no</span>
<span class="s">#KerberosOrLocalPasswd yes</span>
<span class="s">#KerberosTicketCleanup yes</span>
<span class="s">#KerberosGetAFSToken no</span>

<span class="s"># GSSAPI options</span>
<span class="s">#GSSAPIAuthentication no</span>
<span class="s">#GSSAPICleanupCredentials yes</span>
<span class="s">#GSSAPIStrictAcceptorCheck yes</span>
<span class="s">#GSSAPIKeyExchange no</span>

<span class="s"># Set this to &#39;yes&#39; to enable PAM authentication, account processing,</span>
<span class="s"># and session processing. If this is enabled, PAM authentication will</span>
<span class="s"># be allowed through the ChallengeResponseAuthentication and</span>
<span class="s"># PasswordAuthentication.  Depending on your PAM configuration,</span>
<span class="s"># PAM authentication via ChallengeResponseAuthentication may bypass</span>
<span class="s"># the setting of &quot;PermitRootLogin without-password&quot;.</span>
<span class="s"># If you just want the PAM account and session checks to run without</span>
<span class="s"># PAM authentication, then enable this but set PasswordAuthentication</span>
<span class="s"># and ChallengeResponseAuthentication to &#39;no&#39;.</span>
<span class="s">UsePAM yes</span>

<span class="s">#AllowAgentForwarding yes</span>
<span class="s">#AllowTcpForwarding yes</span>
<span class="s">#GatewayPorts no</span>
<span class="s">X11Forwarding yes</span>
<span class="s">#X11DisplayOffset 10</span>
<span class="s">#X11UseLocalhost yes</span>
<span class="s">#PermitTTY yes</span>
<span class="s">PrintMotd no</span>
<span class="s">#PrintLastLog yes</span>
<span class="s">#TCPKeepAlive yes</span>
<span class="s">#UseLogin no</span>
<span class="s">#PermitUserEnvironment no</span>
<span class="s">#Compression delayed</span>
<span class="s">#ClientAliveInterval 0</span>
<span class="s">#ClientAliveCountMax 3</span>
<span class="s">#UseDNS no</span>
<span class="s">#PidFile /var/run/sshd.pid</span>
<span class="s">#MaxStartups 10:30:100</span>
<span class="s">#PermitTunnel no</span>
<span class="s">#ChrootDirectory none</span>
<span class="s">#VersionAddendum none</span>

<span class="s"># no default banner path</span>
<span class="s">#Banner none</span>

<span class="s"># Allow client to pass locale environment variables</span>
<span class="s">AcceptEnv LANG LC_*</span>

<span class="s"># override default of no subsystems</span>
<span class="s">Subsystem   sftp    /usr/lib/openssh/sftp-server</span>

<span class="s"># Example of overriding settings on a per-user basis</span>
<span class="s">#Match User anoncvs</span>
<span class="s">#   X11Forwarding no</span>
<span class="s">#   AllowTcpForwarding no</span>
<span class="s">#   PermitTTY no</span>
<span class="s">#   ForceCommand cvs server</span>
<span class="s">EOF</span>
</pre></div>
</td></tr></table>

<h4 id="delete-roots-authorized_keys-file">Delete root's <code>authorized_keys</code> file<a class="headerlink" href="#delete-roots-authorized_keys-file" title="Permanent link">&para;</a></h4>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Please check before if you can login to the user <code>user</code> with your ssh-key!</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>rm ~/.ssh/authorized_keys
</pre></div>
</td></tr></table>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Log out and re login as <code>user</code>!</p>
</div>
<h3 id="install-base-packages">Install base packages<a class="headerlink" href="#install-base-packages" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt install -y <span class="se">\</span>
p7zip-full <span class="se">\</span>
p7zip-rar <span class="se">\</span>
zip <span class="se">\</span>
unzip <span class="se">\</span>
unrar <span class="se">\</span>
screen <span class="se">\</span>
tmux <span class="se">\</span>
htop
</pre></div>
</td></tr></table>

<h2 id="docker">Docker<a class="headerlink" href="#docker" title="Permanent link">&para;</a></h2>
<h3 id="pre-requirements">Pre-requirements<a class="headerlink" href="#pre-requirements" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
</pre></div>
</td></tr></table>

<h3 id="install-docker">Install Docker<a class="headerlink" href="#install-docker" title="Permanent link">&para;</a></h3>
<div class="admonition info">
<p class="admonition-title">The following steps are shortened!</p>
<p>Here is the full Guide to install docker on Ubuntu 18.04 (Bionic Beaver)<br />
<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04</a></p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add - <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo apt update <span class="o">&amp;&amp;</span> <span class="se">\</span>
apt-cache policy docker-ce <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">echo</span> <span class="s2">&quot;Verify that docker-ce will be installed from the docker repository instead of the ubuntu repo.&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">read</span> -p <span class="s2">&quot;Press any key to continue or press CTRL-C to abort... &quot;</span> -n1 -s <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo apt install -y docker-ce <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo systemctl status docker
</pre></div>
</td></tr></table>

<h3 id="create-a-new-docker-network-for-concourse">Create a new docker network for concourse<a class="headerlink" href="#create-a-new-docker-network-for-concourse" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo docker network create <span class="se">\</span>
  -d bridge <span class="se">\</span>
  -o <span class="s2">&quot;com.docker.network.bridge.name&quot;</span><span class="o">=</span><span class="s2">&quot;docker1&quot;</span> <span class="se">\</span>
  -o <span class="s2">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  -o <span class="s2">&quot;com.docker.network.bridge.enable_icc&quot;</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  -o <span class="s2">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span> <span class="se">\</span>
  -o <span class="s2">&quot;com.docker.network.driver.mtu&quot;</span><span class="o">=</span><span class="s2">&quot;1500&quot;</span> <span class="se">\</span>
  --scope<span class="o">=</span><span class="nb">local</span> <span class="se">\</span>
  --subnet<span class="o">=</span><span class="m">172</span>.23.0.0/16 <span class="se">\</span>
  --ip-range<span class="o">=</span><span class="m">172</span>.23.42.0/24 <span class="se">\</span>
  --gateway<span class="o">=</span><span class="m">172</span>.23.0.1 <span class="se">\</span>
  concourse_net
</pre></div>
</td></tr></table>

<h3 id="install-portainer">Install Portainer<a class="headerlink" href="#install-portainer" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo docker volume create portainer_data <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo docker run <span class="se">\</span>
  --name portainer <span class="se">\</span>
  --volume /var/run/docker.sock:/var/run/docker.sock <span class="se">\</span>
  --volume portainer_data:/data <span class="se">\</span>
  --network concourse_net <span class="se">\</span>
  --ip <span class="m">172</span>.23.0.10 <span class="se">\</span>
  --restart unless-stopped <span class="se">\</span>
  --detach <span class="se">\</span>
  portainer/portainer
</pre></div>
</td></tr></table>

<h2 id="postgresql">PostgreSQL<a class="headerlink" href="#postgresql" title="Permanent link">&para;</a></h2>
<h3 id="install">Install<a class="headerlink" href="#install" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">PSQL_CONCOURSE_USER</span><span class="o">=</span><span class="k">$(</span>cat /dev/urandom <span class="p">|</span> tr -dc <span class="s1">&#39;a-zA-Z0-9&#39;</span> <span class="p">|</span> fold -w <span class="m">32</span> <span class="p">|</span> head -n <span class="m">1</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nv">PSQL_CONCOURSE_PW</span><span class="o">=</span><span class="k">$(</span>cat /dev/urandom <span class="p">|</span> tr -dc <span class="s1">&#39;a-zA-Z0-9&#39;</span> <span class="p">|</span> fold -w <span class="m">32</span> <span class="p">|</span> head -n <span class="m">1</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo docker volume create pgdata <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo docker run <span class="se">\</span>
  --name concourse-db <span class="se">\</span>
  --volume pgdata:/var/lib/postgresql/data <span class="se">\</span>
  --network concourse_net <span class="se">\</span>
  --hostname concourse-db <span class="se">\</span>
  --ip <span class="m">172</span>.23.1.10 <span class="se">\</span>
  --restart unless-stopped <span class="se">\</span>
  --env <span class="nv">POSTGRES_USER</span><span class="o">=</span><span class="nv">$PSQL_CONCOURSE_USER</span> <span class="se">\</span>
  --env <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span><span class="nv">$PSQL_CONCOURSE_PW</span> <span class="se">\</span>
  --env <span class="nv">POSTGRES_DB</span><span class="o">=</span>atc <span class="se">\</span>
  --detach <span class="se">\</span>
  postgres:10.4-alpine <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">echo</span> -e <span class="s2">&quot;User:\t\t</span><span class="nv">$PSQL_CONCOURSE_USER</span><span class="s2">&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="nb">echo</span> -e <span class="s2">&quot;Password:\t</span><span class="nv">$PSQL_CONCOURSE_PW</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="backup">Backup<a class="headerlink" href="#backup" title="Permanent link">&para;</a></h3>
<h1 id="todo">TODO<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h1>
<h2 id="concourse">Concourse<a class="headerlink" href="#concourse" title="Permanent link">&para;</a></h2>
<h3 id="pre-requirements_1">Pre-requirements<a class="headerlink" href="#pre-requirements_1" title="Permanent link">&para;</a></h3>
<p>Create a GitHub OAuth app for authentication:</p>
<p>Follow this Guide:<br />
<a href="https://concourse-ci.org/install.html#github-auth-config">https://concourse-ci.org/install.html#github-auth-config</a></p>
<h3 id="install-web-interface">Install Web interface<a class="headerlink" href="#install-web-interface" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">read</span> -p <span class="s2">&quot;Enter your GitHub client ID: &quot;</span> GITHUB_CLIENT_ID <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
<span class="nb">set</span> <span class="nv">GITHUB_CLIENT_SECRET</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="nb">set</span> <span class="nv">GITHUB_CLIENT_SECRET_confirm</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="nb">read</span> -s -p <span class="s2">&quot;Enter your GitHub client secret: &quot;</span> GITHUB_CLIENT_SECRET<span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="nb">read</span> -s -p <span class="s2">&quot;Reenter your GitHub client secret: &quot;</span> GITHUB_CLIENT_SECRET_confirm<span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$GITHUB_CLIENT_SECRET</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="nv">$GITHUB_CLIENT_SECRET_confirm</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
break<span class="p">;</span> <span class="se">\</span>
<span class="k">else</span> <span class="se">\</span>
clear<span class="p">;</span> <span class="se">\</span>
<span class="nb">echo</span> <span class="s2">&quot;Your secrets don&#39;t match! Please try again.&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="k">fi</span><span class="p">;</span> <span class="se">\</span>
<span class="k">done</span><span class="p">;</span> <span class="se">\</span>
<span class="nv">CONCOURSE_ADMIN_USER</span><span class="o">=</span>admin <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nv">CONCOURSE_ADMIN_PW</span><span class="o">=</span><span class="k">$(</span>cat /dev/urandom <span class="p">|</span> tr -dc <span class="s1">&#39;a-zA-Z0-9&#39;</span> <span class="p">|</span> fold -w <span class="m">32</span> <span class="p">|</span> head -n <span class="m">1</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nv">CONCOUSE_WEB_IP</span><span class="o">=</span><span class="s1">&#39;172.23.1.11&#39;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nv">ORG_NAME</span><span class="o">=</span><span class="s2">&quot;mischaufen&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nv">TEAM_NAME</span><span class="o">=</span><span class="s2">&quot;main&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo docker volume create concourse-keys <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f  /var/lib/docker/volumes/concourse-keys/_data/tsa_host_key <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo chmod <span class="m">600</span> /var/lib/docker/volumes/concourse-keys/_data/tsa_host_key <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo touch /var/lib/docker/volumes/concourse-keys/_data/authorized_worker_keys <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo chmod <span class="m">600</span> /var/lib/docker/volumes/concourse-keys/_data/authorized_worker_keys <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /var/lib/docker/volumes/concourse-keys/_data/worker_key <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo chmod <span class="m">600</span> /var/lib/docker/volumes/concourse-keys/_data/worker_key <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo cat /var/lib/docker/volumes/concourse-keys/_data/worker_key.pub <span class="p">|</span> sudo tee -a /var/lib/docker/volumes/concourse-keys/_data/authorized_worker_keys <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /var/lib/docker/volumes/concourse-keys/_data/session_signing_key <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo chmod <span class="m">600</span> /var/lib/docker/volumes/concourse-keys/_data/session_signing_key <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo docker run <span class="se">\</span>
  --name concourse-web <span class="se">\</span>
  --volume concourse-keys:/concourse-keys <span class="se">\</span>
  --network concourse_net <span class="se">\</span>
  --hostname concourse-web <span class="se">\</span>
  --ip <span class="nv">$CONCOUSE_WEB_IP</span> <span class="se">\</span>
  --privileged <span class="se">\</span>
  --restart unless-stopped <span class="se">\</span>
  --detach <span class="se">\</span>
  concourse/concourse:4.2.1 web <span class="se">\</span>
  --tsa-host-key<span class="o">=</span><span class="s1">&#39;/concourse-keys/tsa_host_key&#39;</span> <span class="se">\</span>
  --tsa-authorized-keys<span class="o">=</span><span class="s1">&#39;/concourse-keys/authorized_worker_keys&#39;</span> <span class="se">\</span>
  --tsa-session-signing-key<span class="o">=</span><span class="s1">&#39;/concourse-keys/session_signing_key&#39;</span> <span class="se">\</span>
  --add-local-user<span class="o">=</span><span class="nv">$CONCOURSE_ADMIN_USER</span>:<span class="nv">$CONCOURSE_ADMIN_PW</span> <span class="se">\</span>
  --main-team-local-user<span class="o">=</span><span class="nv">$CONCOURSE_ADMIN_USER</span> <span class="se">\</span>
  --github-client-id<span class="o">=</span><span class="nv">$GITHUB_CLIENT_ID</span> <span class="se">\</span>
  --github-client-secret<span class="o">=</span><span class="nv">$GITHUB_CLIENT_SECRET</span> <span class="se">\</span>
  --main-team-github-team<span class="o">=</span><span class="nv">$ORG_NAME</span>:<span class="nv">$TEAM_NAME</span> <span class="se">\</span>
  --postgres-user<span class="o">=</span><span class="nv">$PSQL_CONCOURSE_USER</span> <span class="se">\</span>
  --postgres-password<span class="o">=</span><span class="nv">$PSQL_CONCOURSE_PW</span> <span class="se">\</span>
  --postgres-host<span class="o">=</span><span class="k">$(</span>sudo docker inspect -f <span class="s2">&quot;{{ .NetworkSettings.Networks.concourse_net.IPAddress }}&quot;</span> concourse-db<span class="k">)</span> <span class="se">\</span>
  --postgres-port<span class="o">=</span><span class="m">5432</span> <span class="se">\</span>
  --bind-ip<span class="o">=</span><span class="nv">$CONCOUSE_WEB_IP</span> <span class="se">\</span>
  --external-url<span class="o">=</span><span class="s1">&#39;https://ci.mischaufen.de&#39;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">echo</span> -e <span class="s2">&quot;User:\t\t</span><span class="nv">$CONCOURSE_ADMIN_USER</span><span class="s2">&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="nb">echo</span> -e <span class="s2">&quot;Password:\t</span><span class="nv">$CONCOURSE_ADMIN_PW</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table>

<h3 id="install-worker">Install worker<a class="headerlink" href="#install-worker" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">CONCOURSE_WORKER_IP</span><span class="o">=</span><span class="m">172</span>.23.1.12 <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo docker run <span class="se">\</span>
  --name concourse-worker <span class="se">\</span>
  --volume concourse-keys:/concourse-keys <span class="se">\</span>
  --network concourse_net <span class="se">\</span>
  --hostname concourse-worker <span class="se">\</span>
  --ip <span class="nv">$CONCOURSE_WORKER_IP</span> <span class="se">\</span>
  --privileged <span class="se">\</span>
  --restart unless-stopped <span class="se">\</span>
  --detach <span class="se">\</span>
  concourse/concourse:4.2.1 worker <span class="se">\</span>
  --tsa-host<span class="o">=</span><span class="k">$(</span>sudo docker inspect -f <span class="s2">&quot;{{ .NetworkSettings.Networks.concourse_net.IPAddress }}&quot;</span> concourse-web<span class="k">)</span>:2222 <span class="se">\</span>
  --garden-dns-server<span class="o">=</span><span class="m">1</span>.1.1.1 <span class="se">\</span>
  --garden-dns-proxy-enable
</pre></div>
</td></tr></table>

<h2 id="fly">fly<a class="headerlink" href="#fly" title="Permanent link">&para;</a></h2>
<h3 id="install-fly">Install fly<a class="headerlink" href="#install-fly" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo wget -O /root/fly_updater.sh https://gist.githubusercontent.com/shokinn/9eb8b9e39e8a73e4ad085cd9c75a3b4f/raw/3c3b29cc08c927bdd60253050b248d9e9f33d67d/fly_updater.sh <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo chmod u+x /root/fly_updater.sh <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo /root/fly_updater.sh
</pre></div>
</td></tr></table>

<h3 id="configure">Configure<a class="headerlink" href="#configure" title="Permanent link">&para;</a></h3>
<p>First, let's check that we can access the Concourse service with the <code>fly</code> command line client.</p>
<p>We have to log in using the administrative username and password that we configured in the <code>/etc/concourse/web_environment</code> file using the <code>login</code> subcommand. A single <code>fly</code> binary can be used to contact and manage multiple Concourse servers, so the command uses a concept called "targets" as an alias for different servers. We will call our target "local" to log into the local Concourse server:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>fly -t <span class="nb">local</span> login -c http://<span class="k">$(</span>sudo docker inspect -f <span class="s2">&quot;{{ .NetworkSettings.Networks.concourse_net.IPAddress }}&quot;</span> concourse-web<span class="k">)</span>:8080
</pre></div>
</td></tr></table></p>
<p>You will be prompted for going to <code>http://172.23.1.11:8080/sky/login?redirect_uri=http://127.0.0.1:33277/auth/callback</code>. Do the following instead:</p>
<p>Add a port forwarding (on your local PC) from <code>8080</code> to <code>172.23.1.11:8080</code> and go to:<br />
<a href="http://127.0.0.1:8080/sky/login?redirect_uri=http://127.0.0.1:8080/sky/token">http://127.0.0.1:8080/sky/login?redirect_uri=http://127.0.0.1:8080/sky/token</a></p>
<p>Now copy/paste the token to your promt.</p>
<p>This indicates that we were able to log in successfully. While we are here, let's verify that the worker process was able to successfully register to the TSA component by typing:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>fly -t <span class="nb">local</span> workers
</pre></div>
</td></tr></table></p>
<p>Output:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>name              containers  platform  tags  team  state    version
concourse-server  0           linux     none  none  running  2.1
</pre></div>
</td></tr></table></p>
<p>The <code>fly</code> command is used to configure pipelines and manage the Concourse CI service. The <code>fly help</code> command provides information about additional commands.</p>
<h2 id="nginx">Nginx<a class="headerlink" href="#nginx" title="Permanent link">&para;</a></h2>
<h3 id="install_1">Install<a class="headerlink" href="#install_1" title="Permanent link">&para;</a></h3>
<p>Install all needed Packages for nginx tasks: 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt update <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo apt install -y <span class="se">\</span>
nginx <span class="se">\</span>
python3-pip <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo -H pip3 install --system --upgrade <span class="se">\</span>
pip <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo -H pip3 install --upgrade <span class="se">\</span>
setuptools <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo -H pip3 install --upgrade <span class="se">\</span>
cryptography <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo -H pip3 install <span class="se">\</span>
certbot <span class="se">\</span>
certbot-nginx
</pre></div>
</td></tr></table></p>
<h3 id="configure_1">Configure<a class="headerlink" href="#configure_1" title="Permanent link">&para;</a></h3>
<h4 id="delete-default-entry">Delete default entry<a class="headerlink" href="#delete-default-entry" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo rm /etc/nginx/sites-enabled/default
</pre></div>
</td></tr></table>

<h4 id="add-ssl_params">Add ssl_params<a class="headerlink" href="#add-ssl_params" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF | sudo tee /etc/nginx/ssl_params</span>
<span class="s"># Session settings</span>
<span class="s">ssl_session_timeout 1d;</span>
<span class="s">ssl_session_cache shared:SSL:50m;</span>
<span class="s">ssl_session_tickets off;</span>

<span class="s"># modern configuration. tweak to your needs.</span>
<span class="s">ssl_protocols TLSv1.2;</span>
<span class="s">ssl_ciphers &#39;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256&#39;;</span>
<span class="s">ssl_prefer_server_ciphers on;</span>

<span class="s"># HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)</span>
<span class="s">add_header Strict-Transport-Security max-age=15768000;</span>

<span class="s"># OCSP Stapling ---</span>
<span class="s"># fetch OCSP records from URL in ssl_certificate and cache them</span>
<span class="s">ssl_stapling on;</span>
<span class="s">ssl_stapling_verify on;</span>
<span class="s">EOF</span>
</pre></div>
</td></tr></table>

<h4 id="general-http-to-https-redirector">General HTTP to HTTPS redirector<a class="headerlink" href="#general-http-to-https-redirector" title="Permanent link">&para;</a></h4>
<p>This nginx entry will rewrite all traffic from HTTP to HTTPS.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">read</span> -r -d <span class="s1">&#39;&#39;</span> read_tmp&lt;&lt;<span class="s2">&quot;EOF&quot;</span>
server <span class="o">{</span>
<span class="se">\t</span>listen <span class="m">80</span> default_server<span class="p">;</span>
<span class="se">\t</span>listen <span class="o">[</span>::<span class="o">]</span>:80 default_server<span class="p">;</span>
<span class="se">\t</span>server_name _<span class="p">;</span>
<span class="se">\t</span>return <span class="m">301</span> https://<span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="o">}</span>
EOF
<span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$read_tmp</span><span class="s2">&quot;</span> <span class="p">|</span> sudo tee /etc/nginx/sites-available/99-https-rewrite.conf <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo ln -s ../sites-available/99-https-rewrite.conf /etc/nginx/sites-enabled/99-https-rewrite.conf
</pre></div>
</td></tr></table></p>
<h4 id="portainer">Portainer<a class="headerlink" href="#portainer" title="Permanent link">&para;</a></h4>
<p>Add server directive for Portainer:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">portainer_ip</span><span class="o">=</span><span class="k">$(</span>sudo docker inspect -f <span class="s2">&quot;{{ .NetworkSettings.Networks.concourse_net.IPAddress }}&quot;</span> portainer<span class="k">)</span><span class="p">;</span> <span class="se">\</span>
cat <span class="s">&lt;&lt; EOF | sed &#39;s/\\t/\t/g&#39; | sudo tee /etc/nginx/sites-available/10-portainer.ci.mischaufen.de.conf &amp;&amp; \</span>
<span class="s">sudo ln -s ../sites-available/10-portainer.ci.mischaufen.de.conf /etc/nginx/sites-enabled/10-portainer.ci.mischaufen.de.conf</span>
<span class="s">server {</span>
<span class="s">\tlisten\t\t443 ssl http2;</span>
<span class="s">\tlisten\t\t[::]:443 ssl http2;</span>
<span class="s">\tserver_name\tportainer.ci.mischaufen.de;</span>

<span class="s">\taccess_log\t/var/log/nginx/portainer.ci.mischaufen.de_access.log combined gzip=9;</span>
<span class="s">\terror_log\t/var/log/nginx/portainer.ci.mischaufen.de_error.log warn;</span>

<span class="s">\tlocation / {</span>
<span class="s">\t\tset \$upstream_endpoint http://$portainer_ip:9000;</span>
<span class="s">\t\tproxy_http_version\t1.1;</span>
<span class="s">\t\tproxy_set_header\tConnection &quot;&quot;;</span>
<span class="s">\t\tproxy_set_header\tHost \$host;</span>
<span class="s">\t\tproxy_set_header\tX-Forwarded-Host \$server_name;</span>
<span class="s">\t\tadd_header\t\tX-Upstream \$upstream_addr;</span>
<span class="s">\t\tproxy_pass\t\t\$upstream_endpoint;</span>
<span class="s">\t}</span>

<span class="s">\tlocation /api/websocket/ {</span>
<span class="s">\t\tset \$upstream_endpoint http://$portainer_ip:9000;</span>
<span class="s">\t\tproxy_buffering\t\toff;</span>
<span class="s">\t\tproxy_set_header\tUpgrade \$http_upgrade;</span>
<span class="s">\t\tproxy_set_header\tConnection &quot;Upgrade&quot;;</span>
<span class="s">\t\tproxy_set_header\tHost \$host;</span>
<span class="s">\t\tproxy_set_header\tX-Forwarded-Server \$host;</span>
<span class="s">\t\tproxy_set_header\tX-Forwarded-For \$proxy_add_x_forwarded_for;</span>
<span class="s">\t\tproxy_set_header\tX-Forwarded-Host \$server_name;</span>
<span class="s">\t\tadd_header\t\tX-Upstream \$upstream_addr;</span>
<span class="s">\t\tproxy_http_version\t1.1;</span>
<span class="s">\t\tproxy_pass\t\t\$upstream_endpoint;</span>
<span class="s">\t\t# Need this for the console</span>
<span class="s">\t\tproxy_redirect\t\thttp://$portainer_ip:9000 \$scheme://\$host/;</span>
<span class="s">\t}</span>

<span class="s">\tinclude\t\t/etc/nginx/ssl_params;</span>

<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>
</td></tr></table></p>
<p>Install a Let's encrypt SSL Certificate:</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don't add a redirect to HTTPS.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo certbot --nginx -d portainer.ci.mischaufen.de <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo sed -i <span class="s1">&#39;/ssl_certificate_key/a \ \ \ \ ssl_trusted_certificate /etc/letsencrypt/live/portainer.ci.mischaufen.de/chain.pem;&#39;</span> /etc/nginx/sites-available/10-portainer.ci.mischaufen.de.conf <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo systemctl reload nginx.service
</pre></div>
</td></tr></table>

<h4 id="concourse_1">Concourse<a class="headerlink" href="#concourse_1" title="Permanent link">&para;</a></h4>
<p>Add server directive for Concourse:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF | sed &#39;s/\\t/\t/g&#39; | sudo tee /etc/nginx/sites-available/11-ci.mischaufen.de.conf &amp;&amp; \</span>
<span class="s">sudo ln -s ../sites-available/11-ci.mischaufen.de.conf /etc/nginx/sites-enabled/11-ci.mischaufen.de.conf</span>
<span class="s">upstream concourse {</span>
<span class="s">\tserver\t\t$(sudo docker inspect -f &quot;{{ .NetworkSettings.Networks.concourse_net.IPAddress }}&quot; concourse-web):8080;</span>
<span class="s">}</span>

<span class="s">server {</span>
<span class="s">\tlisten\t\t443 ssl http2;</span>
<span class="s">\tlisten\t\t[::]:443 ssl http2;</span>
<span class="s">\tserver_name\tci.mischaufen.de;</span>

<span class="s">\taccess_log\t/var/log/nginx/ci.mischaufen.de_access.log combined gzip=9;</span>
<span class="s">\terror_log\t/var/log/nginx/ci.mischaufen.de_error.log warn;</span>

<span class="s">\tlocation / {</span>
<span class="s">\t\tinclude\t\t\tproxy_params;</span>
<span class="s">\t\tproxy_http_version\t1.1;</span>
<span class="s">\t\tproxy_read_timeout\t90;</span>

<span class="s">\t\tproxy_set_header\tUpgrade \$http_upgrade;</span>
<span class="s">\t\tproxy_set_header\tConnection &quot;upgrade&quot;;</span>

<span class="s">\t\tproxy_pass\t\thttp://concourse;</span>
<span class="s">\t}</span>

<span class="s">\tinclude\t\t/etc/nginx/ssl_params;</span>

<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>
</td></tr></table></p>
<p>Check if config is ok:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo nginx -t
</pre></div>
</td></tr></table></p>
<p>Install a Let's encrypt SSL Certificate:</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don't add a redirect to HTTPS.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo certbot --nginx -d ci.mischaufen.de <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo sed -i <span class="s1">&#39;/ssl_certificate_key/a \ \ \ \ ssl_trusted_certificate /etc/letsencrypt/live/ci.mischaufen.de/chain.pem;&#39;</span> /etc/nginx/sites-available/11-ci.mischaufen.de.conf <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo systemctl reload nginx.service
</pre></div>
</td></tr></table>

<h3 id="add-cronjob-for-renewing-cetificates">Add cronjob for renewing cetificates<a class="headerlink" href="#add-cronjob-for-renewing-cetificates" title="Permanent link">&para;</a></h3>
<p><code>sudo crontab -e</code>:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>0 */12 * * * /usr/local/bin/certbot renew
</pre></div>
</td></tr></table></p>
<h2 id="security">Security<a class="headerlink" href="#security" title="Permanent link">&para;</a></h2>
<h3 id="iptables">iptables<a class="headerlink" href="#iptables" title="Permanent link">&para;</a></h3>
<details class="tip"><summary>Explanation iptables rules</summary><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Allow loopback</span>
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT

<span class="c1"># Allow SSH incoming</span>
iptables -t filter -A INPUT -i eth0 -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT

<span class="c1"># Allow web interface SeedBox incoming</span>
iptables -t filter -A INPUT -i eth0 -p tcp -m multiport --dports <span class="m">80</span>,443 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT

<span class="c1"># Policy DROP INPUT on `eth0`</span>
iptables -t filter -A INPUT -i eth0 -j DROP<span class="p">;</span>

<span class="c1"># Allow output on `eth0`</span>
iptables -t filter -A OUTPUT -o eth0 -j ACCEPT
</pre></div>
</td></tr></table>

</details>
<p>Set up needed iptables rules:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo iptables -A OUTPUT -o lo -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo iptables -A INPUT -i lo -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo iptables -t filter -A INPUT -i eth0 -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo iptables -t filter -A INPUT -i eth0 -p tcp -m multiport --dports <span class="m">80</span>,443 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo iptables -t filter -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo iptables -t filter -A INPUT -i eth0 -p icmp -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo iptables -t filter -A INPUT -i eth0 -j DROP<span class="p">;</span> <span class="se">\</span>
sudo iptables -t filter -A OUTPUT -o eth0 -j ACCEPT
</pre></div>
</td></tr></table>
Set up needed ip6tables rules:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo ip6tables -A OUTPUT -o lo -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -A INPUT -i lo -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -t filter -A INPUT -i eth0 -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -t filter -A INPUT -i eth0 -p tcp -m multiport --dports <span class="m">80</span>,443 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -t filter -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -t filter -A INPUT -i eth0 -p ipv6-icmp -j ACCEPT<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -t filter -A INPUT -i eth0 -j DROP<span class="p">;</span> <span class="se">\</span>
sudo ip6tables -t filter -A OUTPUT -o eth0 -j ACCEPT
</pre></div>
</td></tr></table></p>
<p>Persist iptables rules:<br />
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt install -y iptables-persistent <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo netfilter-persistent save <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo netfilter-persistent reload
</pre></div>
</td></tr></table></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../desktop/playonlinux/" title="PlayOnLinux" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                PlayOnLinux
              </span>
            </div>
          </a>
        
        
          <a href="../quassel/" title="Quassel" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Quassel
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="http://pphg.tech" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://keybase.io/philip_henning" class="md-footer-social__link fa fa-key"></a>
    
      <a href="https://twitter.com/__phg" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://github.com/shokinn" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://gitlab.com/shokinn" class="md-footer-social__link fa fa-gitlab"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>